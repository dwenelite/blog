---
title: "Cara konfigurasi RTC Module DS3231 di Raspberry Pi pada Ubuntu 20.04"
date: 2020-08-31T10:41:03+07:00
draft: false
penulis: ["davidwahyu"]

---

Kali ini saya ingin mencoba menggunakan RTC pada Raspberry Pi 3B+ yang menggunakan Ubuntu 20.04 sebagai sistem operasinya. 
Pada ubuntu 20.04 ARM ini, saya dapati tidak ada tersedia layanan `raspi-config`. Di mana fungsi dari `raspi-config` merupakan alat konfigurasi untuk mengatur system yang terhubung dengan papan komputer Raspberry.

## Daftar isi:
- [Daftar isi:](#daftar-isi)
- [Install `raspi-config`](#install-raspi-config)
- [Mengatur Modul RTC](#mengatur-modul-rtc)
- [Menggunakan Mudul RTC pada Raspberry](#menggunakan-mudul-rtc-pada-raspberry)
- [Membuat RCT DS3231 menjadi Jam Utama](#membuat-rct-ds3231-menjadi-jam-utama)
- [Membuat service RTC DS3231](#membuat-service-rtc-ds3231)
- [Menyinkronkan Waktu Raspi dengan RTC](#menyinkronkan-waktu-raspi-dengan-rtc)
  - [referensi](#referensi)


## Install `raspi-config`
Langkah untuk mengatasi ini yaitu dengan menginstall sendiri paket dari `raspi-config` pada sistem operasi Ubuntu. 

Dari hasil pencarian, saya mendapatkan sebuah repository github. Di mana pada repository tersebut menyediakan berkas konfigurasi untuk menginstall paket dari `raspi-config`.

```
git clone https://github.com/EmilGus/install_raspi-config.git
```
- ekstrak berkas kompresi `.zip` lalu masuk pada direktori berkas tersebut
- `unzip file.zip`
- lalu ubah permission pada berkas `install.sh` agar bisa dijalankan melalui command-line
```
sudo chmod +x install.sh
```
- lalu jalankan perintah untuk mengeksekusi berkas `install.sh`
- tunggu proses installasinya hingga selesai. 
 

## Mengatur Modul RTC 
Setelah selesai maka bisa kita mengaktifkan `I2C` pada Raspi.
```
sudo raspi-config
```
pada menu configuration-tool pilih `Interfacing Option` 
```
    gambar menu configuration-tool (raspi-config)
```
lalu aktifkan I2C dengan memilih menu **P5 I2C**.
```
    gambar menu I2C
```
simpan konfigurasi dan muat ulang Raspi.
```
sudo reboot
```
Dengan mengaktifkan antarmuka I2C, maka kita bisa menggunakan RTC Modul.  
Sebelum menginstall apapun pada Raspi, usahakan Raspi sudah dalam kondisi up-to-date. Karena terkadang ditemukan error pada proses installasi dari paket atau depedensi yang disebabkan firmware dari Raspi belum terupdate.

```
sudo apt-get update -y
sudo apt-get upgrade -y
```

Pada percobaan ini kita membutuhkan paket dari **python3-smbus I2C-tools** supaya Raspi mendeteksi perangkat pada koneksi **I2C**
jalankan pada terminal:
```
sudo apt-get install python-smbus I2C-tools
```
Lalu coba hasilnya untuk medateksi alamat dari perangkat **I2C**
```
sudo I2Cdetect -y 1
```
dari perintah tersebut kita dapati `0x68` merupakan alamat dari perangkat **DS3231**. Jika alamat yang tampil berupa `UU`, kemungkinan alamat sudah digunakan melalui driver.

## Menggunakan Mudul RTC pada Raspberry
Pada langkah ini, kita perlu mengatur modul D3231 untuk bisa digunakan secara langsung pada Raspi. Ikuti langkah berkut hingga selesai.

Kita perlu merubah file config.txt dan menambahkan perangkat kita.
```
sudo vi /boot/config.txt
```

![raspi](static/raspi1.png)

lalu tambahkan modul RTC yang kita gunakan.
```
dtoverlay=i2c-rtc,ds1307
```
atau
```
dtoverlay=i2c-rtc,pcf8523
```
atau
```
dtoverlay=i2c-rtc,ds3231
```

Simpan dan muat ulang Raspi untuk memeriksa alamat I2C.
```
sudo reboot
sudo i2cdetect -y 1
```

```
    gambar i2c
```

## Membuat RCT DS3231 menjadi Jam Utama
Untuk membuat modul RTC DS3231 menjadi pokok jam utama, kita perlu mengkonfigurasi file sistem jam pada Raspi dengan menjalankan perintah `sudo vi /lib/udev/hwclock-set` dan tambahkan comment `#` pada baris file konfigurasi, seperti berikut:

```
#if [-e/run/systemd/system];then

#exit 0

#if
```
```
#/sbin/hwclock --rtc=$dev --systz --badyear

#/sbin/hwclock --rtc=$dev --systz
```

## Membuat service RTC DS3231
Agar modul RTC dapat berjalan ketika nyala pertama kali, kita perlu membuat sebuah service dari modul.  
kita perlu menulis sendiri file service pada `systemd` agar dapat dijalankan oleh sistem. jalankan perintah berikut `sudo vi /etc/systemd/system/ds3231.service` dan tambahkan file konfigurasi berikut:

```
[Unit]
Description=Enable DS3231 I2C RTC

[Service]
Type=oneshot
ExecStartPre=/bin/bash -c "echo ds1307 0x68 | tee /sys/class/i2c-adapter/i2c-1/new_device"
ExecStart=/sbin/hwclock -s

[Install]
WantedBy=basic.target
```

Simpan dan coba kita aktifkan dan menjalankan service yang sudah kita buat.
```
sudo systemctl enable ds3231.service
sudo systemctl start ds3231.service
```
setelah kita mengaktifkan service, pastikan bahwa service kita sudah berjalan dengan normal.
```
sudo systemctl status ds3231
```

## Menyinkronkan Waktu Raspi dengan RTC
Setelah kita melakukan konfigurasi hardware RTC DS3231, maka perlu kita koreksi waktu dari hardware RTC.
Untuk melihat waktu yang berjalan di RTC
```
sudo hwclock
```

untuk mengkoreksi waktu yang berjalan, kita harus terputus pada jaringan internet agar dapat mengetahui bahwa modul RTC bisa berjalan dengan baik.

Beberapa perintah yang digunakan untuk melihat hasil konfigirasi:

- `date`        - Untuk membaca waktu dari Raspi
- `hwclock -r`  - Untuk membaca waktu pada modul RTC
- `hwclock -w`  - Untuk menulis waktu ke modul RTC dari Raspi
- `hwclock -s`  - Untuk membaca waktu ke Raspi dari modul RTC
- `hwclock -c`  - Untuk menampilkan waktu antara Raspi dan modul RTC dengan interval


### referensi
- https://github.com/EmilGus/install_raspi-config/
- https://maker.pro/raspberry-pi/tutorial/how-to-add-an-rtc-module-to-raspberry-pi
- https://www.willhughes.name/post/ds3231_raspi3/